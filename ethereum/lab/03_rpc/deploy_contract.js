const axios = require('axios');

class JsonRpcRequester {
    #baseURL;
    #axios;

    constructor(baseURL) {
        this.#baseURL = baseURL;
        this.#axios = axios.create({ baseURL });
        this.id = 1;
    }

    get baseURL() {
        return this.#baseURL;
    }

    async request(req) {
        if (!req.id) {
            req.id = this.id;
            ++this.id;
        }
        req.params = req.params ? req.params : [];
        const body = { jsonrpc: "2.0", ...req };
        return (await this.#axios.post("/", body)).data;
    }
}
/*  
npx wscat -c http://192.168.100.73:8545 {"method":"eth_subscribe","params":["newHeads",{"fromBlock":"latest","toBlock":"latest"}],"id":1,"jsonrpc":"2.0"}
*/
(async()=>{
    const rpc = new JsonRpcRequester('http://192.168.100.73:8545');


    console.log(" --- contract deploy --- ")
    const contractByteCode = "0x608060405234801561001057600080fd5b506103ae806100206000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c80632e64cec11461003b578063e1ff178a14610059575b600080fd5b610043610075565b60405161005091906100da565b60405180910390f35b610073600480360381019061006e919061027b565b61007e565b005b60008054905090565b81600081905550817fe26105263485e8a84501f797b95b792fff09698ee033d83956846b26ab2f8ffb826040516100b59190610356565b60405180910390a25050565b6000819050919050565b6100d4816100c1565b82525050565b60006020820190506100ef60008301846100cb565b92915050565b6000604051905090565b600080fd5b600080fd5b610112816100c1565b811461011d57600080fd5b50565b60008135905061012f81610109565b92915050565b600080fd5b600080fd5b6000601f19601f8301169050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6101888261013f565b810181811067ffffffffffffffff821117156101a7576101a6610150565b5b80604052505050565b60006101ba6100f5565b90506101c6828261017f565b919050565b600067ffffffffffffffff8211156101e6576101e5610150565b5b6101ef8261013f565b9050602081019050919050565b82818337600083830152505050565b600061021e610219846101cb565b6101b0565b90508281526020810184848401111561023a5761023961013a565b5b6102458482856101fc565b509392505050565b600082601f83011261026257610261610135565b5b813561027284826020860161020b565b91505092915050565b60008060408385031215610292576102916100ff565b5b60006102a085828601610120565b925050602083013567ffffffffffffffff8111156102c1576102c0610104565b5b6102cd8582860161024d565b9150509250929050565b600081519050919050565b600082825260208201905092915050565b60005b838110156103115780820151818401526020810190506102f6565b60008484015250505050565b6000610328826102d7565b61033281856102e2565b93506103428185602086016102f3565b61034b8161013f565b840191505092915050565b60006020820190508181036000830152610370818461031d565b90509291505056fea26469706673582212206aaf2f2f9949439e527ac693759caf301a4c7a0a81855e0cdf490a5339f320c364736f6c63430008110033"
    const resultOfDeployment = await rpc.request({
        method:"eth_sendTransaction",
        params:[{
            from: '0x92acC145431bfdA701d64a6C4347A8B65293Ac58',
            gasPrice: 21000,
            gas: 1000000,
            data: contractByteCode,
            value: 100000000000000000,
        }]
    });
    console.log(resultOfDeployment);
    const txHash = resultOfDeployment.result;
    console.log('----------')

    const blockInfo = await rpc.request({
        method: "eth_getTransactionByHash",
        params:[txHash]
    })

    console.log(blockInfo);

    console.log(" ---- RECEIPT ---- ")
    setInterval(async()=>{
        const receiptInfo = await rpc.request({
            method: 'eth_getTransactionReceipt',
            params:[txHash],
        })
        console.log(receiptInfo); // 없으면 result는 null이다.
    }, 1000)
})()

// {
//   id: 2,
//   jsonrpc: '2.0',
//   result: {
//     hash: '0x50060a0fed372ede4d28ed783e22474a2d3dc40e74c92680ad917c7a2a155a2f',
//     nonce: '0x8b',
//     blockHash: null,
//     blockNumber: null,
//     transactionIndex: null,
//     from: '0x92acc145431bfda701d64a6c4347a8b65293ac58',
//     to: null,
//     value: '0x16345785d8a0000',
//     gas: '0xf4240',
//     gasPrice: '0x5208',
//     input: '0x608060405234801561001057600080fd5b50610187806100206000396000f3fe608060405234801561001057600080fd5b50600436106100365760003560e01c80632e64cec11461003b5780636057361d14610059575b600080fd5b610043610075565b60405161005091906100d8565b60405180910390f35b610073600480360381019061006e9190610124565b61007e565b005b60008054905090565b806000819055507faf242753da7ca3b45d3e8bf8e738e0a0a62477d7cb3665554fa25faa7448dfbe816040516100b491906100d8565b60405180910390a150565b6000819050919050565b6100d2816100bf565b82525050565b60006020820190506100ed60008301846100c9565b92915050565b600080fd5b610101816100bf565b811461010c57600080fd5b50565b60008135905061011e816100f8565b92915050565b60006020828403121561013a576101396100f3565b5b60006101488482850161010f565b9150509291505056fea26469706673582212207b1927b320ab73c98bbc5045a79d77d154c8a1aed3a44992259962d1b7cca59764736f6c63430008110033',
//     v: '0x26',
//     r: '0x2b32cccee5e7a970efb29d534b1fb2f1acad776be32c49cc3a43fe5f4ce57a83',
//     s: '0x4996e63c8fc8a3995a4d9a596f622a1bad8a273849e12f1daf6b3fe689a2ff51'
//   }
// }

// {
//   id: 30,
//   jsonrpc: '2.0',
//   result: {
//     transactionHash: '0x50060a0fed372ede4d28ed783e22474a2d3dc40e74c92680ad917c7a2a155a2f',
//     transactionIndex: '0x0',
//     blockHash: '0x201194d0bec87150903072c674252c11bb24d85bae0038292cdfa7684b928a6a',
//     blockNumber: '0x15a',
//     from: '0x92acc145431bfda701d64a6c4347a8b65293ac58',
//     to: null,
//     gasUsed: '0xe7b9',
//     cumulativeGasUsed: '0xe7b9',
//     contractAddress: '0xc0e980d0ec79b9b855bdf50d0786190241da4b91',
//     logs: [],
//     status: '0x0',
//     logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
//   }
// }

// if send ether
// {
//   id: 20,
//   jsonrpc: '2.0',
//   result: {
//     transactionHash: '0xe7a623b78c1f1967511054df7f334daef3079db0f8fdefad89bd41c0f321ba1f',
//     transactionIndex: '0x0',
//     blockHash: '0xbd987e937c9043bb35e5532b740ccc2089d44dea8fd8d26fe47a737524a48d97',
//     blockNumber: '0x15f',
//     from: '0x92acc145431bfda701d64a6c4347a8b65293ac58',
//     to: '0x26a88097dceec3addd255dc5ac2c04ee773f5663',
//     gasUsed: '0x5208',
//     cumulativeGasUsed: '0x5208',
//     contractAddress: null,
//     logs: [],
//     status: '0x1',
//     logsBloom: '0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000'
//   }
// }